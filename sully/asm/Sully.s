section .text
  global _main

  ; stdio.h
  extern _sprintf
  extern _fprintf
  extern _dprintf
  extern _fopen
  extern _fclose

  ; unistd.h
  extern _system
  extern _execlp

  ; err.h
  extern _err

  ; stdlib.h
  extern _exit

  ;string.h
  extern _strrchr
  extern _strcmp

%define STRING 115,101,99,116,105,111,110,32,46,116,101,120,116,10,32,32,103,108,111,98,97,108,32,95,109,97,105,110,10,10,32,32,59,32,115,116,100,105,111,46,104,10,32,32,101,120,116,101,114,110,32,95,115,112,114,105,110,116,102,10,32,32,101,120,116,101,114,110,32,95,102,112,114,105,110,116,102,10,32,32,101,120,116,101,114,110,32,95,100,112,114,105,110,116,102,10,32,32,101,120,116,101,114,110,32,95,102,111,112,101,110,10,32,32,101,120,116,101,114,110,32,95,102,99,108,111,115,101,10,10,32,32,59,32,117,110,105,115,116,100,46,104,10,32,32,101,120,116,101,114,110,32,95,115,121,115,116,101,109,10,32,32,101,120,116,101,114,110,32,95,101,120,101,99,108,112,10,10,32,32,59,32,101,114,114,46,104,10,32,32,101,120,116,101,114,110,32,95,101,114,114,10,10,32,32,59,32,115,116,100,108,105,98,46,104,10,32,32,101,120,116,101,114,110,32,95,101,120,105,116,10,10,32,32,59,115,116,114,105,110,103,46,104,10,32,32,101,120,116,101,114,110,32,95,115,116,114,114,99,104,114,10,32,32,101,120,116,101,114,110,32,95,115,116,114,99,109,112,10,10,37,37,100,101,102,105,110,101,32,83,84,82,73,78,71,32,37,115,10,37,37,100,101,102,105,110,101,32,65,83,95,83,84,82,73,78,71,40,38,120,41,32,120,10,10,95,109,97,105,110,58,10,32,32,112,117,115,104,32,114,98,112,10,32,32,109,111,118,32,114,98,112,44,32,114,115,112,10,32,32,115,117,98,32,114,115,112,44,32,49,54,10,10,32,32,109,111,118,32,100,119,111,114,100,32,91,114,115,112,93,44,32,37,100,10,32,32,99,109,112,32,100,119,111,114,100,32,91,114,115,112,93,44,32,48,10,32,32,106,108,101,32,95,109,97,105,110,95,101,110,100,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,102,105,108,101,110,97,109,101,93,10,32,32,109,111,118,32,101,115,105,44,32,39,47,39,10,32,32,99,97,108,108,32,95,115,116,114,114,99,104,114,10,32,32,99,109,112,32,114,97,120,44,32,48,10,32,32,106,101,32,110,111,116,95,102,111,117,110,100,10,32,32,105,110,99,32,114,97,120,10,32,32,106,109,112,32,101,110,100,95,115,101,97,114,99,104,10,110,111,116,95,102,111,117,110,100,58,10,32,32,108,101,97,32,114,97,120,44,32,91,114,101,108,32,102,105,108,101,110,97,109,101,93,10,101,110,100,95,115,101,97,114,99,104,58,10,32,32,109,111,118,32,114,100,105,44,32,114,97,120,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,111,114,105,103,105,110,95,110,97,109,101,93,10,32,32,99,97,108,108,32,95,115,116,114,99,109,112,10,32,32,99,109,112,32,101,97,120,44,32,48,10,32,32,106,101,32,115,107,105,112,95,115,117,98,10,32,32,115,117,98,32,100,119,111,114,100,32,91,114,115,112,93,44,32,49,10,115,107,105,112,95,115,117,98,58,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,111,117,116,95,115,111,117,114,99,101,95,110,97,109,101,93,44,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,111,117,116,95,115,111,117,114,99,101,95,116,101,109,112,108,97,116,101,93,10,32,32,109,111,118,32,101,100,120,44,32,91,114,115,112,93,10,32,32,120,111,114,32,114,97,120,44,32,114,97,120,10,32,32,99,97,108,108,32,95,115,112,114,105,110,116,102,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,111,117,116,95,111,98,106,101,99,116,95,110,97,109,101,93,44,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,111,117,116,95,111,98,106,101,99,116,95,116,101,109,112,108,97,116,101,93,10,32,32,109,111,118,32,101,100,120,44,32,91,114,115,112,93,10,32,32,120,111,114,32,114,97,120,44,32,114,97,120,10,32,32,99,97,108,108,32,95,115,112,114,105,110,116,102,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,111,117,116,95,98,105,110,97,114,121,95,110,97,109,101,93,44,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,111,117,116,95,98,105,110,97,114,121,95,116,101,109,112,108,97,116,101,93,10,32,32,109,111,118,32,101,100,120,44,32,91,114,115,112,93,10,32,32,120,111,114,32,114,97,120,44,32,114,97,120,10,32,32,99,97,108,108,32,95,115,112,114,105,110,116,102,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,111,117,116,95,115,111,117,114,99,101,95,110,97,109,101,93,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,102,108,97,103,95,119,114,105,116,101,95,111,110,108,121,93,10,32,32,99,97,108,108,32,95,102,111,112,101,110,10,10,32,32,99,109,112,32,114,97,120,44,32,48,10,32,32,106,110,101,32,111,112,101,110,95,115,117,99,99,101,115,115,10,32,32,109,111,118,32,114,100,105,44,32,49,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,102,111,112,101,110,93,10,32,32,99,97,108,108,32,95,101,114,114,10,10,111,112,101,110,95,115,117,99,99,101,115,115,58,10,32,32,109,111,118,32,91,114,115,112,32,43,32,56,93,44,32,114,97,120,10,32,32,109,111,118,32,114,100,105,44,32,114,97,120,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,109,115,103,93,10,32,32,108,101,97,32,114,100,120,44,32,91,114,101,108,32,109,101,116,97,109,115,103,93,10,32,32,109,111,118,32,101,99,120,44,32,91,114,115,112,93,10,32,32,99,97,108,108,32,95,102,112,114,105,110,116,102,10,10,32,32,109,111,118,32,114,100,105,44,32,91,114,115,112,32,43,32,56,93,10,32,32,99,97,108,108,32,95,102,99,108,111,115,101,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,99,111,109,112,105,108,101,95,99,109,100,93,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,99,111,109,112,105,108,101,95,99,109,100,95,116,101,109,112,108,97,116,101,93,10,32,32,108,101,97,32,114,100,120,44,32,91,114,101,108,32,111,117,116,95,115,111,117,114,99,101,95,110,97,109,101,93,10,32,32,108,101,97,32,114,99,120,44,32,91,114,101,108,32,111,117,116,95,98,105,110,97,114,121,95,110,97,109,101,93,10,32,32,108,101,97,32,114,56,44,32,91,114,101,108,32,111,117,116,95,111,98,106,101,99,116,95,110,97,109,101,93,10,32,32,108,101,97,32,114,57,44,32,91,114,101,108,32,111,117,116,95,111,98,106,101,99,116,95,110,97,109,101,93,10,32,32,99,97,108,108,32,95,115,112,114,105,110,116,102,10,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,99,111,109,112,105,108,101,95,99,109,100,93,10,32,32,99,97,108,108,32,95,115,121,115,116,101,109,10,10,32,32,99,109,112,32,101,97,120,44,32,48,10,32,32,106,98,32,115,121,115,116,101,109,95,101,114,114,111,114,10,32,32,106,110,101,32,110,111,110,95,122,101,114,111,95,101,114,114,111,114,10,32,32,106,109,112,32,115,121,115,116,101,109,95,115,117,99,99,101,115,115,10,115,121,115,116,101,109,95,101,114,114,111,114,58,10,32,32,109,111,118,32,101,100,105,44,32,50,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,115,121,115,116,101,109,93,10,32,32,99,97,108,108,32,95,101,114,114,10,110,111,110,95,122,101,114,111,95,101,114,114,111,114,58,10,32,32,109,111,118,32,101,100,105,44,32,50,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,115,104,101,108,108,95,110,111,110,95,122,101,114,111,93,10,32,32,109,111,118,32,101,100,120,44,32,101,97,120,10,32,32,109,111,118,32,101,99,120,44,32,49,48,10,32,32,99,97,108,108,32,95,100,112,114,105,110,116,102,10,32,32,109,111,118,32,101,100,105,44,32,51,10,32,32,99,97,108,108,32,95,101,120,105,116,10,115,121,115,116,101,109,95,115,117,99,99,101,115,115,58,10,32,32,108,101,97,32,114,100,105,44,32,91,114,101,108,32,111,117,116,95,98,105,110,97,114,121,95,110,97,109,101,93,10,32,32,109,111,118,32,114,115,105,44,32,48,10,32,32,99,97,108,108,32,95,101,120,101,99,108,112,10,32,32,109,111,118,32,101,100,105,44,32,52,44,10,32,32,108,101,97,32,114,115,105,44,32,91,114,101,108,32,101,120,101,99,93,10,32,32,108,101,97,32,114,100,120,44,32,91,114,101,108,32,111,117,116,95,98,105,110,97,114,121,95,110,97,109,101,93,10,32,32,99,97,108,108,32,95,101,114,114,10,10,95,109,97,105,110,95,101,110,100,58,10,32,32,109,111,118,32,114,115,112,44,32,114,98,112,10,32,32,112,111,112,32,114,98,112,10,32,32,120,111,114,32,114,97,120,44,32,114,97,120,10,32,32,114,101,116,10,10,115,101,99,116,105,111,110,32,46,98,115,115,10,32,32,111,117,116,95,115,111,117,114,99,101,95,110,97,109,101,32,100,98,32,48,120,52,48,32,100,117,112,32,63,10,32,32,111,117,116,95,111,98,106,101,99,116,95,110,97,109,101,32,100,98,32,48,120,52,48,32,100,117,112,32,63,10,32,32,111,117,116,95,98,105,110,97,114,121,95,110,97,109,101,32,100,98,32,48,120,52,48,32,100,117,112,32,63,10,32,32,99,111,109,112,105,108,101,95,99,109,100,32,100,98,32,48,120,52,48,48,32,100,117,112,32,63,10,10,115,101,99,116,105,111,110,32,46,100,97,116,97,10,32,32,111,114,105,103,105,110,95,110,97,109,101,32,100,98,32,39,83,117,108,108,121,46,115,39,44,32,48,10,32,32,102,105,108,101,110,97,109,101,32,100,98,32,95,95,70,73,76,69,95,95,44,32,48,10,32,32,111,117,116,95,115,111,117,114,99,101,95,116,101,109,112,108,97,116,101,32,100,98,32,39,46,47,83,117,108,108,121,95,37,37,100,46,115,39,44,32,48,10,32,32,111,117,116,95,111,98,106,101,99,116,95,116,101,109,112,108,97,116,101,32,100,98,32,39,46,47,83,117,108,108,121,95,37,37,100,46,111,39,44,32,48,10,32,32,111,117,116,95,98,105,110,97,114,121,95,116,101,109,112,108,97,116,101,32,100,98,32,39,46,47,83,117,108,108,121,95,37,37,100,39,44,32,48,10,32,32,102,108,97,103,95,119,114,105,116,101,95,111,110,108,121,32,100,98,32,39,119,39,44,32,48,10,32,32,102,111,112,101,110,32,100,98,32,39,102,111,112,101,110,39,44,32,48,10,32,32,115,121,115,116,101,109,32,100,98,32,39,115,121,115,116,101,109,39,44,32,48,10,32,32,115,104,101,108,108,95,110,111,110,95,122,101,114,111,32,100,98,32,39,115,121,115,116,101,109,58,32,115,104,101,108,108,32,101,120,105,116,101,100,32,119,105,116,104,32,110,111,110,45,122,101,114,111,45,118,97,108,117,101,58,32,37,37,100,92,110,39,44,32,48,10,32,32,101,120,101,99,32,100,98,32,39,101,120,101,99,58,32,96,37,37,115,96,39,44,32,48,10,32,32,99,111,109,112,105,108,101,95,99,109,100,95,116,101,109,112,108,97,116,101,32,100,98,32,39,110,97,115,109,32,45,102,32,109,97,99,104,111,54,52,32,37,37,115,32,38,38,32,99,108,97,110,103,32,45,87,97,108,108,32,45,87,101,120,116,114,97,32,45,87,101,114,114,111,114,32,45,111,32,37,37,115,32,37,37,115,32,38,38,32,114,109,32,37,37,115,39,44,32,48,10,10,32,32,109,115,103,32,100,98,32,83,84,82,73,78,71,44,32,48,10,32,32,109,101,116,97,109,115,103,32,100,98,32,65,83,95,83,84,82,73,78,71,40,83,84,82,73,78,71,41,44,32,48
%define AS_STRING(&x) x

_main:
  push rbp
  mov rbp, rsp
  sub rsp, 16

  mov dword [rsp], 5
  cmp dword [rsp], 0
  jle _main_end

  lea rdi, [rel filename]
  mov esi, '/'
  call _strrchr
  cmp rax, 0
  je not_found
  inc rax
  jmp end_search
not_found:
  lea rax, [rel filename]
end_search:
  mov rdi, rax
  lea rsi, [rel origin_name]
  call _strcmp
  cmp eax, 0
  je skip_sub
  sub dword [rsp], 1
skip_sub:

  lea rdi, [rel out_source_name],
  lea rsi, [rel out_source_template]
  mov edx, [rsp]
  xor rax, rax
  call _sprintf

  lea rdi, [rel out_object_name],
  lea rsi, [rel out_object_template]
  mov edx, [rsp]
  xor rax, rax
  call _sprintf

  lea rdi, [rel out_binary_name],
  lea rsi, [rel out_binary_template]
  mov edx, [rsp]
  xor rax, rax
  call _sprintf

  lea rdi, [rel out_source_name]
  lea rsi, [rel flag_write_only]
  call _fopen

  cmp rax, 0
  jne open_success
  mov rdi, 1
  lea rsi, [rel fopen]
  call _err

open_success:
  mov [rsp + 8], rax
  mov rdi, rax
  lea rsi, [rel msg]
  lea rdx, [rel metamsg]
  mov ecx, [rsp]
  call _fprintf

  mov rdi, [rsp + 8]
  call _fclose

  lea rdi, [rel compile_cmd]
  lea rsi, [rel compile_cmd_template]
  lea rdx, [rel out_source_name]
  lea rcx, [rel out_binary_name]
  lea r8, [rel out_object_name]
  lea r9, [rel out_object_name]
  call _sprintf

  lea rdi, [rel compile_cmd]
  call _system

  cmp eax, 0
  jb system_error
  jne non_zero_error
  jmp system_success
system_error:
  mov edi, 2
  lea rsi, [rel system]
  call _err
non_zero_error:
  mov edi, 2
  lea rsi, [rel shell_non_zero]
  mov edx, eax
  mov ecx, 10
  call _dprintf
  mov edi, 3
  call _exit
system_success:
  lea rdi, [rel out_binary_name]
  mov rsi, 0
  call _execlp
  mov edi, 4,
  lea rsi, [rel exec]
  lea rdx, [rel out_binary_name]
  call _err

_main_end:
  mov rsp, rbp
  pop rbp
  xor rax, rax
  ret

section .bss
  out_source_name db 0x40 dup ?
  out_object_name db 0x40 dup ?
  out_binary_name db 0x40 dup ?
  compile_cmd db 0x400 dup ?

section .data
  origin_name db 'Sully.s', 0
  filename db __FILE__, 0
  out_source_template db './Sully_%d.s', 0
  out_object_template db './Sully_%d.o', 0
  out_binary_template db './Sully_%d', 0
  flag_write_only db 'w', 0
  fopen db 'fopen', 0
  system db 'system', 0
  shell_non_zero db 'system: shell exited with non-zero-value: %d\n', 0
  exec db 'exec: `%s`', 0
  compile_cmd_template db 'nasm -f macho64 %s && clang -Wall -Wextra -Werror -o %s %s && rm %s', 0

  msg db STRING, 0
  metamsg db AS_STRING(STRING), 0